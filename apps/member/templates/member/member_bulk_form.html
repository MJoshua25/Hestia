{% extends 'base.html' %}
{% load static %}

{% block title %}Ajouter plusieurs membres{% endblock %}

{% block content %}
<div id="bulk-add-app" class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <a href="{% url 'member:member_list' %}"
                class="inline-flex items-center text-ios-blue font-medium mb-2 hover:opacity-80 transition-opacity min-h-touch">
                <svg class="w-5 h-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Retour
            </a>
            <h1 class="text-2xl font-bold text-ios-gray-900">Ajout multiple</h1>
            <p class="text-ios-gray-500 text-sm mt-1">Ajoutez jusqu'à 20 membres à la fois.</p>
        </div>
        
        <div class="flex gap-3">
             <button @click="addRow" type="button" 
                class="btn-secondary-ios flex items-center justify-center min-h-touch">
                <svg class="w-5 h-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Ajouter une ligne
            </button>
            <button @click="saveAll" :disabled="isSubmitting || members.length === 0" 
                class="btn-primary-ios flex items-center justify-center min-h-touch"
                :class="{'opacity-50 cursor-not-allowed': isSubmitting || members.length === 0}">
                <span v-if="isSubmitting">Enregistrement...</span>
                <span v-else>Enregistrer tout</span>
            </button>
        </div>
    </div>

    <!-- Error/Success Messages -->
    <div v-if="errorMessage" class="mb-4 p-4 rounded-ios bg-ios-red/10 border border-ios-red/20 text-ios-red">
        <p class="font-medium">Erreur</p>
        <ul class="list-disc list-inside text-sm mt-1">
            <li v-for="(err, idx) in errorList" :key="idx">[[ err ]]</li>
        </ul>
    </div>

    <!-- Form Table -->
    <div class="card-ios overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-ios-gray-200">
                <thead class="bg-ios-gray-50">
                    <tr>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-ios-gray-500 uppercase tracking-wider">Prénom</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-ios-gray-500 uppercase tracking-wider">Nom</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-ios-gray-500 uppercase tracking-wider">Téléphone (+225)</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-ios-gray-500 uppercase tracking-wider">Chambre</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-ios-gray-500 uppercase tracking-wider">Rôle</th>
                        <th scope="col" class="relative px-4 py-3">
                            <span class="sr-only">Actions</span>
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-ios-gray-200">
                    <tr v-for="(member, index) in members" :key="index" class="hover:bg-ios-gray-50 transition-colors">
                        <td class="px-4 py-3 whitespace-nowrap">
                            <input type="text" v-model="member.first_name" 
                                class="input-ios w-full text-sm" placeholder="Prénom" required>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <input type="text" v-model="member.last_name" 
                                class="input-ios w-full text-sm" placeholder="Nom" required>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <input type="text" :id="'phone-' + index" v-model="member.display_phone" 
                                @input="updatePhone(index, $event)"
                                class="input-ios w-full text-sm font-mono" placeholder="+225 01 02 03 04 05" required>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <input type="text" v-model="member.room_number" 
                                class="input-ios w-24 text-sm" placeholder="101" required>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <select v-model="member.role" class="input-ios w-full text-sm py-1">
                                <option value="MEMBER">Membre</option>
                                <option value="DELEGATE">Déléguée</option>
                                <option value="ADMIN">Admin</option>
                            </select>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                            <button @click="removeRow(index)" class="text-ios-red hover:text-ios-red/80 p-2">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                    <tr v-if="members.length === 0">
                        <td colspan="6" class="px-6 py-10 text-center text-ios-gray-500">
                            Aucun membre à ajouter. Cliquez sur "Ajouter une ligne" pour commencer.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/imask"></script>
<script>
    // Separate Vue app for the content block to avoid conflict with mobile menu
    const bulkApp = Vue.createApp({
        delimiters: ['[[', ']]'], // Change delimiters to avoid conflict with Django
        data() {
            return {
                members: [
                    { first_name: '', last_name: '', phone_number: '', display_phone: '', room_number: '', role: 'MEMBER' }
                ],
                isSubmitting: false,
                errorMessage: '',
                errorList: [],
                phoneMasks: []
            }
        },
        mounted() {
            this.$nextTick(() => {
                this.initMasks();
            });
        },
        updated() {
            this.$nextTick(() => {
                this.initMasks();
            });
        },
        methods: {
            initMasks() {
                // Initialize IMask for all phone inputs
                this.members.forEach((_, index) => {
                    const element = document.getElementById('phone-' + index);
                    if (element && !this.phoneMasks[index]) {
                        const mask = IMask(element, {
                            mask: '+{225} 00 00 00 00 00',
                            lazy: false,  // Show placeholder always
                            placeholderChar: '_'
                        });
                        
                        // Sync model on accept
                        mask.on('accept', () => {
                            this.members[index].display_phone = mask.value;
                            this.members[index].phone_number = mask.unmaskedValue;
                        });
                        
                        this.phoneMasks[index] = mask;
                    }
                });
            },
            updatePhone(index, event) {
                // Handled by IMask events, but keep v-model for reactivity
            },
            addRow() {
                this.members.push({ first_name: '', last_name: '', phone_number: '', display_phone: '', room_number: '', role: 'MEMBER' });
            },
            removeRow(index) {
                if (this.phoneMasks[index]) {
                    this.phoneMasks[index].destroy();
                    this.phoneMasks.splice(index, 1); // Remove mask instance
                }
                this.members.splice(index, 1);
                
                // Re-init masks because indices shifted
                // Actually, best to destroy all and re-init or track by ID. 
                // For simplicity, we just clear mask array (except destroyed ones) and let updated hook re-bind.
                // But `updated` might re-bind to wrong element if we don't clear.
                this.phoneMasks = []; 
                // Wait for Vue to update DOM then re-init
            },
            async saveAll() {
                this.errorMessage = '';
                this.errorList = [];
                
                // Frontend Validation
                let isValid = true;
                const errors = [];
                
                this.members.forEach((m, i) => {
                    if (!m.first_name || !m.last_name || !m.room_number) {
                        isValid = false;
                        errors.push(`Ligne ${i+1}: Tous les champs sont requis.`);
                    }
                    // Check phone length (225 + 10 digits = 13 chars in unmasked value usually, 
                    // but unmaskedValue from IMask with +{225} might just be 22501... 
                    // Let's check the unmasked length. Ivory Coast is 10 digits after country code.
                    // Country code is 225. So total 13 digits.
                    if (!m.phone_number || m.phone_number.length < 13) {
                         // unmaskedValue includes 225.
                         isValid = false;
                         errors.push(`Ligne ${i+1}: Numéro de téléphone incomplet.`);
                    }
                });
                
                if (!isValid) {
                    this.errorMessage = "Veuillez corriger les erreurs.";
                    this.errorList = errors;
                    return;
                }

                this.isSubmitting = true;

                try {
                    // Format data for backend
                    // Backend expects phone_number to be stored. 
                    // We should probably store it with +225 prefix if that's the convention.
                    // The model regex expects +?1?\d... 
                    // IMask unmasked value might be '2250102...'
                    // Let's ensure it has +.
                    
                    const payload = this.members.map(m => ({
                        ...m,
                        phone_number: '+' + m.phone_number // Ensure + prefix
                    }));

                    const response = await fetch('{% url "member:member_bulk_add" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ members: payload })
                    });

                    const data = await response.json();

                    if (data.success) {
                        window.location.href = data.redirect_url;
                    } else {
                        this.errorMessage = "Erreur lors de l'enregistrement";
                        this.errorList = data.errors || [data.error];
                    }
                } catch (e) {
                    this.errorMessage = "Une erreur inattendue est survenue.";
                    console.error(e);
                } finally {
                    this.isSubmitting = false;
                }
            }
        }
    });
    
    bulkApp.mount('#bulk-add-app');
</script>
{% endblock %}
