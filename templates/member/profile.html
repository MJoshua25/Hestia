{% extends 'base.html' %}
{% load static %}

{% block title %}Mon Profil - Hestia{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <h1 class="text-3xl font-bold text-gray-900">Mon Profil</h1>

    <!-- Stats Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-white p-4 rounded-ios shadow-ios">
            <p class="text-sm text-gray-500 uppercase tracking-wide">√âv√©nements</p>
            <p class="text-2xl font-bold text-gray-900">{{ stats.events_count }}</p>
            <p class="text-xs text-gray-400">participations</p>
        </div>
        <div class="bg-white p-4 rounded-ios shadow-ios">
            <p class="text-sm text-gray-500 uppercase tracking-wide">Commissions</p>
            <p class="text-2xl font-bold text-gray-900">{{ stats.commissions_count }}</p>
            <p class="text-xs text-gray-400">commissions diff√©rentes</p>
        </div>
        <div class="bg-white p-4 rounded-ios shadow-ios">
            <p class="text-sm text-gray-500 uppercase tracking-wide">Responsabilit√©s</p>
            <p class="text-2xl font-bold text-gray-900">{{ stats.responsibilities_count }}</p>
            <p class="text-xs text-gray-400">fois responsable</p>
        </div>
        <div class="bg-white p-4 rounded-ios shadow-ios">
            <p class="text-sm text-gray-500 uppercase tracking-wide">Derni√®re</p>
            <p class="text-lg font-bold text-gray-900 truncate">{{ stats.last_participation.event.title|default:"Aucune" }}</p>
            <p class="text-xs text-gray-400">{{ stats.last_participation.event.date|timesince|default:"-" }}</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column: Photo & Security -->
        <div class="space-y-6">
            <!-- Photo Section -->
            <div class="bg-white p-6 rounded-ios-lg shadow-ios">
                <h2 class="text-xl font-semibold mb-4">Photo de profil</h2>
                <div class="flex flex-col items-center">
                    <div class="relative w-32 h-32 mb-4">
                        {% if member.photo %}
                            <img src="{{ member.photo.url }}" alt="Profile" class="w-full h-full object-cover rounded-full shadow-md">
                        {% else %}
                            <div class="w-full h-full bg-ios-blue text-white rounded-full flex items-center justify-center text-3xl font-bold shadow-md">
                                {{ member.initials }}
                            </div>
                        {% endif %}
                        
                        <label for="id_photo" class="absolute bottom-0 right-0 bg-white text-gray-700 p-2 rounded-full shadow-ios hover:bg-gray-50 cursor-pointer border border-gray-200">
                            üì∑
                        </label>
                    </div>

                    {% if member.photo %}
                    <form action="{% url 'member:delete_photo' %}" method="post" class="mt-2">
                        {% csrf_token %}
                        <button type="submit" class="text-sm text-ios-red hover:underline" onclick="return confirm('Supprimer votre photo ?')">
                            Supprimer la photo
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>

            <!-- Security Section -->
            <div class="bg-white p-6 rounded-ios-lg shadow-ios">
                <h2 class="text-xl font-semibold mb-4">S√©curit√©</h2>
                
                <!-- Change Password Accordion -->
                <div class="border-b border-gray-100 pb-4 mb-4">
                    <button onclick="document.getElementById('password-form').classList.toggle('hidden')" class="flex justify-between w-full text-left font-medium text-gray-700 hover:text-ios-blue">
                        <span>Changer mon mot de passe</span>
                        <span>‚ñº</span>
                    </button>
                    <div id="password-form" class="hidden mt-4">
                        <form action="{% url 'member:change_password' %}" method="post" class="space-y-3">
                            {% csrf_token %}
                            {% for field in password_form %}
                                <div>
                                    <label class="block text-xs font-medium text-gray-500 mb-1">{{ field.label }}</label>
                                    {{ field }}
                                </div>
                            {% endfor %}
                            <button type="submit" class="w-full bg-gray-900 text-white py-2 rounded-ios text-sm font-medium hover:bg-gray-800">
                                Mettre √† jour
                            </button>
                        </form>
                    </div>
                </div>

                <!-- PIN Code Accordion -->
                <div>
                    <button onclick="document.getElementById('pin-form').classList.toggle('hidden')" class="flex justify-between w-full text-left font-medium text-gray-700 hover:text-ios-blue">
                        <span>G√©rer mon code PIN</span>
                        <span>‚ñº</span>
                    </button>
                    <div id="pin-form" class="hidden mt-4">
                        <div class="text-sm text-gray-500 mb-3">
                            Statut : <span class="font-bold {% if user.pin_code %}text-ios-green{% else %}text-gray-400{% endif %}">
                                {% if user.pin_code %}Actif{% else %}Non d√©fini{% endif %}
                            </span>
                        </div>
                        <form id="pin-update-form" class="space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-1">Nouveau code PIN (6 chiffres)</label>
                                <input type="password" name="pin" maxlength="6" pattern="\d{6}" class="input-ios w-full" required>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-1">Confirmer le code PIN</label>
                                <input type="password" name="confirm_pin" maxlength="6" pattern="\d{6}" class="input-ios w-full" required>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-1">Mot de passe actuel (pour valider)</label>
                                <input type="password" name="password" class="input-ios w-full" required>
                            </div>
                            <button type="submit" class="w-full bg-ios-blue text-white py-2 rounded-ios text-sm font-medium hover:bg-blue-600">
                                {% if user.pin_code %}Modifier le PIN{% else %}D√©finir le PIN{% endif %}
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Personal Info -->
        <div class="lg:col-span-2">
            <div class="bg-white p-6 rounded-ios-lg shadow-ios">
                <h2 class="text-xl font-semibold mb-6">Informations Personnelles</h2>
                
                <form method="post" enctype="multipart/form-data" class="space-y-6">
                    {% csrf_token %}
                    <!-- We render photo field manually above, so hidden here if we want or handled by view -->
                    <!-- But wait, the form has fields. We need to render them. -->
                    <!-- The photo input is triggered by label above, but it must be present in form -->
                    <div class="hidden">
                        {{ form.photo }} 
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Pr√©nom</label>
                            {{ form.first_name }}
                            {{ form.first_name.errors }}
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nom</label>
                            {{ form.last_name }}
                            {{ form.last_name.errors }}
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">T√©l√©phone</label>
                            {{ form.phone_number }}
                            {{ form.phone_number.errors }}
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Chambre</label>
                            {{ form.room_number }}
                            {{ form.room_number.errors }}
                        </div>
                    </div>

                    <div class="flex justify-end pt-4">
                        <button type="submit" class="bg-ios-blue text-white px-6 py-2 rounded-ios font-medium hover:bg-blue-600 shadow-ios transition-transform active:scale-95">
                            Enregistrer les modifications
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Handle PIN Form via AJAX
    document.getElementById('pin-update-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        try {
            const response = await fetch('{% url "member:manage_pin" %}', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            
            if (data.success) {
                Toastify({
                    text: "‚úì Code PIN mis √† jour",
                    duration: 3000,
                    style: { background: "#34C759" }
                }).showToast();
                this.reset();
                setTimeout(() => location.reload(), 1500);
            } else {
                Toastify({
                    text: "‚ùå " + data.error,
                    duration: 5000,
                    style: { background: "#FF3B30" }
                }).showToast();
            }
        } catch (e) {
            console.error(e);
        }
    });

    // Auto-submit photo when changed
    document.getElementById('id_photo').addEventListener('change', function() {
        if (this.files && this.files[0]) {
             // We can either auto-submit the main form or show preview
             // Here let's show preview
             const reader = new FileReader();
             reader.onload = function(e) {
                 const img = document.querySelector('.w-32.h-32 img');
                 if (img) {
                     img.src = e.target.result;
                 } else {
                     // If there was no image (initials div), replace it
                     const div = document.querySelector('.w-32.h-32 div');
                     if (div) {
                         const newImg = document.createElement('img');
                         newImg.src = e.target.result;
                         newImg.className = "w-full h-full object-cover rounded-full shadow-md";
                         div.replaceWith(newImg);
                     }
                 }
                 
                 Toastify({
                    text: "Photo s√©lectionn√©e. N'oubliez pas d'enregistrer.",
                    duration: 3000,
                    style: { background: "#007AFF" }
                }).showToast();
             }
             reader.readAsDataURL(this.files[0]);
        }
    });
</script>
{% endblock %}
